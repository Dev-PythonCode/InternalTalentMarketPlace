@page "/job-board"
@inject IRequirementService RequirementService
@inject IApplicationService ApplicationService
@inject IAuthService AuthService
@inject IEmployeeService EmployeeService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-2">Current Job Openings</MudText>
<MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">Browse internal opportunities that match your skills</MudText>

<!-- Filters with Toggle Switches -->
<MudPaper Class="pa-3 mb-4" Elevation="1">
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudSwitch @bind-Value="_filterByMySkills"
                       @bind-Value:after="OnFiltersChanged"
                       Color="Color.Success"
                       Label="My Skills Only"
                       ThumbIcon="@(_filterByMySkills ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
            </MudSwitch>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-10">
                @if (_filterByMySkills)
                {
                    <span>✅ Showing jobs matching your skills only</span>
                }
                else
                {
                    <span>❌ Showing all jobs regardless of skills</span>
                }
            </MudText>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudSwitch @bind-Value="_filterByMyLocation"
                       @bind-Value:after="OnFiltersChanged"
                       Color="Color.Success"
                       Label="My Location Only"
                       ThumbIcon="@(_filterByMyLocation ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
            </MudSwitch>
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-10">
                @if (_filterByMyLocation)
                {
                    <span>✅ Showing jobs in @(_currentEmployee?.Location ?? "your location") only</span>
                }
                else
                {
                    <span>❌ Showing jobs from all locations</span>
                }
            </MudText>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_filteredRequirements.Any())
{
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
        Showing @_filteredRequirements.Count of @_allRequirements.Count opportunities
    </MudText>

    @foreach (var req in _filteredRequirements)
    {
        var matchScore = _matchScores.GetValueOrDefault(req.RequirementId, 0);
        var hasApplied = _appliedRequirements.Contains(req.RequirementId);
        
        <MudCard Class="mb-3">
            <MudCardContent>
                <div class="d-flex justify-space-between align-start mb-3">
                    <div>
                        <MudText Typo="Typo.h6">@req.Title</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Class="mr-1" />
                            @(req.Team?.TeamName ?? "Any Team") •
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mx-1" />
                            @(req.Location ?? "Any") •
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mx-1" />
                            @req.Duration •
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mx-1" />
                            Posted @GetTimeAgo(req.PostedDate)
                        </MudText>
                    </div>
                    <MudChip T="string" Color="@GetPriorityColor(req.Priority)" Size="Size.Small">
                        @req.Priority Priority
                    </MudChip>
                </div>

                <!-- Match Score -->
                <MudPaper Class="pa-3 mb-3 d-flex align-center" Elevation="0" Style="background: #f5f5f5;">
                    <MudText Typo="Typo.h4" Color="@GetMatchColor(matchScore)" Class="mr-3">
                        @matchScore%
                    </MudText>
                    <div>
                        <MudText Typo="Typo.body1">
                            <strong>@GetMatchText(matchScore)</strong>
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetMatchDescription(matchScore, req)
                        </MudText>
                    </div>
                </MudPaper>

                <!-- Required Skills -->
                <div class="mb-3">
                    <strong>Required Skills:</strong>
                    @foreach (var skill in req.RequirementSkills)
                    {
                        var hasSkill = _mySkillIds.Contains(skill.SkillId);
                        var mySkillYears = _mySkillYears.GetValueOrDefault(skill.SkillId, 0);
                        
                        <MudChip T="string" Size="Size.Small" Class="mr-1 mb-1"
                                 Color="@(hasSkill && mySkillYears >= skill.MinYearsRequired ? Color.Success : 
                                         hasSkill ? Color.Warning : Color.Error)"
                                 Variant="Variant.Filled">
                            @skill.Skill.SkillName - @skill.MinYearsRequired yrs
                            @if (hasSkill && mySkillYears >= skill.MinYearsRequired)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="ml-1" />
                            }
                            else if (hasSkill)
                            {
                                <span class="ml-1">(you: @mySkillYears)</span>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Class="ml-1" />
                            }
                        </MudChip>
                    }
                </div>

                <!-- Actions -->
                <div class="d-flex gap-2">
                    @if (hasApplied)
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Success" Disabled="true"
                                   StartIcon="@Icons.Material.Filled.CheckCircle">
                            Applied
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                   OnClick="@(() => ApplyToJob(req.RequirementId))"
                                   StartIcon="@Icons.Material.Filled.Send">
                            Apply Now
                        </MudButton>
                    }
                    
                    @if (matchScore < 80)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                   OnClick="@(() => ViewLearningPath(req.RequirementId))"
                                   StartIcon="@Icons.Material.Filled.School">
                            View Learning Path
                        </MudButton>
                    }
                </div>
            </MudCardContent>
        </MudCard>
    }
}
else
{
    <MudPaper Class="pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Filled.WorkOff" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-3">No matching opportunities</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @if (_filterByMySkills && _filterByMyLocation)
            {
                <span>No jobs found matching both your skills and location. Try disabling one filter.</span>
            }
            else if (_filterByMySkills)
            {
                <span>No jobs found matching your skills. Try disabling the skill filter.</span>
            }
            else if (_filterByMyLocation)
            {
                <span>No jobs found in your location. Try disabling the location filter.</span>
            }
            else
            {
                <span>Check back later for new requirements.</span>
            }
        </MudText>
    </MudPaper>
}

@code {
    private List<Requirement> _allRequirements = new();
    private List<Requirement> _filteredRequirements = new();
    private Dictionary<int, decimal> _matchScores = new();
    private HashSet<int> _appliedRequirements = new();
    private HashSet<int> _mySkillIds = new();
    private Dictionary<int, decimal> _mySkillYears = new();
    private Employee? _currentEmployee;
    
    private bool _filterByMySkills = true;  // ⭐ Default ON
    private bool _filterByMyLocation = true; // ⭐ Default ON
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            _currentEmployee = await AuthService.GetCurrentEmployeeAsync();
            if (_currentEmployee == null) return;

            Console.WriteLine($"👤 Current Employee: {_currentEmployee.FullName}");
            Console.WriteLine($"📍 Location: {_currentEmployee.Location}");

            // Get employee skills
            var mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee.EmployeeId);
            _mySkillIds = mySkills.Select(s => s.SkillId).ToHashSet();
            _mySkillYears = mySkills.ToDictionary(s => s.SkillId, s => s.YearsOfExperience);
            
            Console.WriteLine($"🎯 My Skills: {string.Join(", ", mySkills.Select(s => s.Skill.SkillName))}");

            // Get all open requirements
            _allRequirements = await RequirementService.GetAllAsync(true);
            Console.WriteLine($"📋 Total Requirements: {_allRequirements.Count}");

            // Get applied requirements
            var applications = await ApplicationService.GetByEmployeeAsync(_currentEmployee.EmployeeId);
            _appliedRequirements = applications.Select(a => a.RequirementId).ToHashSet();

            // Calculate match scores for ALL jobs
            _matchScores.Clear();
            foreach (var req in _allRequirements)
            {
                var matchResult = await EmployeeService.CalculateMatchScoreAsync(
                    _currentEmployee.EmployeeId, req.RequirementId);
                _matchScores[req.RequirementId] = matchResult.MatchPercentage;
            }

            // Apply filters
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading jobs: {ex.Message}", Severity.Error);
            Console.WriteLine($"❌ Error details: {ex}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnFiltersChanged()
    {
        Console.WriteLine($"🔄 Filters Changed - Skill: {_filterByMySkills}, Location: {_filterByMyLocation}");
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        Console.WriteLine($"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
        Console.WriteLine($"🔍 APPLYING FILTERS");
        Console.WriteLine($"Skill Filter: {_filterByMySkills}");
        Console.WriteLine($"Location Filter: {_filterByMyLocation}");
        Console.WriteLine($"Total Requirements: {_allRequirements.Count}");
        
        // ⭐ START WITH ALL REQUIREMENTS
        IEnumerable<Requirement> filtered = _allRequirements;

        // ⭐ ONLY Filter by My Skills if enabled
        if (_filterByMySkills)
        {
            if (_mySkillIds.Any())
            {
                var beforeCount = filtered.Count();
                filtered = filtered.Where(r => 
                    r.RequirementSkills != null && 
                    r.RequirementSkills.Any(rs => _mySkillIds.Contains(rs.SkillId)));
                
                Console.WriteLine($"🎯 Skill Filter APPLIED: {beforeCount} → {filtered.Count()} jobs");
            }
            else
            {
                Console.WriteLine($"🎯 Skill Filter ENABLED but user has no skills - showing 0 jobs");
                filtered = Enumerable.Empty<Requirement>();
            }
        }
        else
        {
            Console.WriteLine($"🎯 Skill Filter DISABLED - showing ALL skills");
        }

        // ⭐ ONLY Filter by My Location if enabled
        if (_filterByMyLocation)
        {
            if (!string.IsNullOrEmpty(_currentEmployee?.Location))
            {
                var beforeCount = filtered.Count();
                var myLocation = _currentEmployee.Location;
                
                filtered = filtered.Where(r => 
                    string.IsNullOrWhiteSpace(r.Location) || 
                    r.Location.Equals("Any", StringComparison.OrdinalIgnoreCase) ||
                    r.Location.Equals(myLocation, StringComparison.OrdinalIgnoreCase));
                
                Console.WriteLine($"📍 Location Filter APPLIED ({myLocation}): {beforeCount} → {filtered.Count()} jobs");
            }
            else
            {
                Console.WriteLine($"📍 Location Filter ENABLED but user has no location set");
            }
        }
        else
        {
            Console.WriteLine($"📍 Location Filter DISABLED - showing ALL locations");
        }

        // Sort by match percentage (descending)
        _filteredRequirements = filtered
            .OrderByDescending(r => _matchScores.GetValueOrDefault(r.RequirementId, 0))
            .ToList();
        
        Console.WriteLine($"✅ FINAL RESULT: {_filteredRequirements.Count} of {_allRequirements.Count} jobs");
        
        // ⭐ DEBUG: Show all filtered job titles
        if (_filteredRequirements.Any())
        {
            foreach (var job in _filteredRequirements)
            {
                var skills = job.RequirementSkills?.Select(rs => rs.Skill.SkillName).ToList() ?? new List<string>();
                Console.WriteLine($"   📄 {job.Title} | Location: [{job.Location ?? "NULL"}] | Skills: {string.Join(", ", skills)}");
            }
        }
        else
        {
            Console.WriteLine($"   ⚠️ No jobs after filtering");
        }
        
        // ⭐ DEBUG: Show what was filtered OUT
        var excludedJobs = _allRequirements.Except(_filteredRequirements).ToList();
        if (excludedJobs.Any())
        {
            Console.WriteLine($"❌ EXCLUDED {excludedJobs.Count} jobs:");
            foreach (var job in excludedJobs)
            {
                var skills = job.RequirementSkills?.Select(rs => rs.Skill.SkillName).ToList() ?? new List<string>();
                Console.WriteLine($"   ✗ {job.Title} | Location: [{job.Location ?? "NULL"}] | Skills: {string.Join(", ", skills)}");
            }
        }
        
        Console.WriteLine($"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━");
    }

    private async Task ApplyToJob(int requirementId)
    {
        if (_currentEmployee == null) return;

        try
        {
            await ApplicationService.ApplyAsync(_currentEmployee.EmployeeId, requirementId, null);
            _appliedRequirements.Add(requirementId);
            Snackbar.Add("Application submitted successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error applying: {ex.Message}", Severity.Error);
        }
    }

    private void ViewLearningPath(int requirementId)
    {
        Navigation.NavigateTo($"/learning?req={requirementId}");
    }

    private Color GetPriorityColor(string priority)
    {
        return priority switch
        {
            "High" => Color.Error,
            "Medium" => Color.Warning,
            "Low" => Color.Success,
            _ => Color.Default
        };
    }

    private Color GetMatchColor(decimal percentage)
    {
        return percentage switch
        {
            >= 80 => Color.Success,
            >= 50 => Color.Warning,
            _ => Color.Error
        };
    }

    private string GetMatchText(decimal percentage)
    {
        return percentage switch
        {
            >= 90 => "Excellent match!",
            >= 80 => "Great match!",
            >= 60 => "Good match with gaps",
            >= 40 => "Partial match",
            _ => "Significant gaps"
        };
    }

    private string GetMatchDescription(decimal percentage, Requirement req)
    {
        if (percentage >= 80)
            return "You meet all required skills";
        
        var missingSkills = req.RequirementSkills
            .Where(rs => !_mySkillIds.Contains(rs.SkillId))
            .Select(rs => rs.Skill.SkillName);
        
        if (missingSkills.Any())
            return $"Missing: {string.Join(", ", missingSkills)}";
        
        return "Some skills need more experience";
    }

    private string GetTimeAgo(DateTime date)
    {
        var diff = DateTime.Now - date;
        if (diff.TotalDays < 1) return "today";
        if (diff.TotalDays < 2) return "yesterday";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} days ago";
        if (diff.TotalDays < 30) return $"{(int)(diff.TotalDays / 7)} weeks ago";
        return date.ToString("MMM dd");
    }
}