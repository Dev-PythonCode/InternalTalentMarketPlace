@page "/application-review"
@page "/application-review/{RequirementId:int}"
@inject IRequirementService RequirementService
@inject IApplicationService ApplicationService
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-2">Application Review</MudText>
<MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
    Review and manage applications for your requirements
</MudText>

@if (_isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="d-block mx-auto my-8" />
    <MudText Typo="Typo.body1" Align="Align.Center">Loading applications...</MudText>
}
else if (!_myRequirements.Any())
{
    <MudPaper Class="pa-8 text-center">
        <MudIcon Icon="@Icons.Material.Filled.PostAdd" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-3">No Requirements Posted</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            You haven't posted any requirements yet.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-3"
                   Href="/post-requirement" StartIcon="@Icons.Material.Filled.Add">
            Post Requirement
        </MudButton>
    </MudPaper>
}
else
{
    <!-- Requirement Selector -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudSelect T="int?" Value="_selectedRequirementId"
                       ValueChanged="OnRequirementChanged"
                       Label="Select Requirement"
                       Variant="Variant.Outlined"
                       Adornment="Adornment.Start"
                       AdornmentIcon="@Icons.Material.Filled.Work">
                @foreach (var req in _myRequirements)
                {
                    var appCount = _applicationCounts.GetValueOrDefault(req.RequirementId, 0);
                    <MudSelectItem T="int?" Value="@req.RequirementId">
                        <div class="d-flex justify-space-between align-center" style="width: 100%;">
                            <div>
                                <strong>Req_@req.RequirementId</strong> - @req.Title
                            </div>
                            <MudChip T="string" Size="Size.Small" Color="Color.Info" Style="margin-left: 8px;">
                                @appCount
                            </MudChip>
                        </div>
                    </MudSelectItem>
                }
            </MudSelect>
        </MudCardContent>
    </MudCard>

    @if (_selectedRequirement != null)
    {
        <!-- Requirement Details -->
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudText Typo="Typo.h6">@_selectedRequirement.Title</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
                            @(_selectedRequirement.Team?.TeamName ?? "Any Team") •
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" />
                            @(_selectedRequirement.Location ?? "Any Location") •
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                            Posted @_selectedRequirement.PostedDate.ToString("MMM dd, yyyy")
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="4" Class="text-right">
                        <MudChip T="string" Color="@GetStatusColor(_selectedRequirement.Status)">
                            @_selectedRequirement.Status
                        </MudChip>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Stats Summary with Filters -->
        @if (_applications.Any())
        {
            <MudPaper Class="pa-3 mb-4" Elevation="1">
                <div class="d-flex gap-2">
                    <MudChip T="string" Color="Color.Primary" OnClick="@(() => ClearFilters())">@_applications.Count Total</MudChip>
                    <MudTooltip Text="Candidate meets or exceeds all mandatory skill requirements with strong experience levels (80%+)">
                        <MudChip T="string" Color="Color.Success" OnClick="@(() => FilterByCategory("GoodFit"))"
                                 Style="@GetFilterStyle("GoodFit")">
                            @_applications.Count(a => a.MatchPercentage >= 80) Good Fit
                        </MudChip>
                    </MudTooltip>
                    <MudTooltip Text="Candidate has foundational skills but would benefit from upskilling (60-79%)">
                        <MudChip T="string" Color="Color.Warning" OnClick="@(() => FilterByCategory("NeedsTraining"))"
                                 Style="@GetFilterStyle("NeedsTraining")">
                            @_applications.Count(a => a.MatchPercentage >= 60 && a.MatchPercentage < 80) Needs Training
                        </MudChip>
                    </MudTooltip>
                    <MudTooltip Text="Significant skill gaps exist for this role (<60%)">
                        <MudChip T="string" Color="Color.Error" OnClick="@(() => FilterByCategory("NotRecommended"))"
                                 Style="@GetFilterStyle("NotRecommended")">
                            @_applications.Count(a => a.MatchPercentage < 60) Not Recommended
                        </MudChip>
                    </MudTooltip>
                </div>
            </MudPaper>
        }

        @if (_applications.Any())
        {
            @foreach (var app in _filteredApplications.OrderByDescending(a => a.MatchPercentage))
            {
                <MudCard Class="mb-3">
                    <MudCardContent>
                        <MudGrid>
                            <!-- Employee Info -->
                            <MudItem xs="12" md="8">
                                <div class="d-flex gap-3 mb-3">
                                    <MudAvatar Size="Size.Large" Color="Color.Primary">
                                        @app.Employee.FullName[0]
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.h6">@app.Employee.FullName</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @app.Employee.Designation • @(app.Employee.Team?.TeamName ?? "No Team") • @app.Employee.Location
                                        </MudText>
                                        @{
                                            var (badgeColor, badgeText) = GetAvailabilityBadge(app.Employee.AvailabilityStatus);
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@badgeColor">@badgeText</MudChip>
                                    </div>
                                </div>
                            </MudItem>
                            
                            <MudItem xs="12" md="4" Class="text-right">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Applied @GetTimeAgo(app.AppliedDate)
                                </MudText>
                            </MudItem>
                        </MudGrid>

                        <!-- Match Score Section (using MatchPercentage for consistency) -->
                        <MudPaper Class="pa-3 mb-3 d-flex align-center" Elevation="0" Style="background: #f5f5f5;">
                            <div class="mr-4">
                                <MudText Typo="Typo.h3" Color="@GetScoreColor(app.MatchPercentage ?? 0)">
                                    @(app.MatchPercentage?.ToString("0.00") ?? "?")%
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Match Score</MudText>
                            </div>
                            <div>
                                <MudText Typo="Typo.body1">
                                    <MudIcon Icon="@GetCategoryIcon(app.MatchPercentage ?? 0)" 
                                             Color="@GetCategoryColor(app.MatchPercentage ?? 0)" Class="mr-1" />
                                    <strong style="color: @GetCategoryColorHex(app.MatchPercentage ?? 0)">
                                        @GetCategoryName(app.MatchPercentage ?? 0)
                                    </strong>
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @GetCategoryDescription(app.MatchPercentage ?? 0)
                                </MudText>
                            </div>
                        </MudPaper>

                        <!-- Missing Skills Summary -->
                        @{
                            var missingSkills = _selectedRequirement?.RequirementSkills?
                                .Where(rs => !app.Employee.EmployeeSkills.Any(es => es.SkillId == rs.SkillId))
                                .ToList() ?? new List<RequirementSkill>();
                        }
                        @if (missingSkills.Any())
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3" Icon="@Icons.Material.Filled.Warning">
                                <strong>Missing:</strong> @string.Join(", ", missingSkills.Select(s => s.Skill.SkillName))
                            </MudAlert>
                        }

                        <!-- Skill Comparison -->
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Skill Comparison</MudText>
                        <MudGrid>
                            @foreach (var reqSkill in _selectedRequirement.RequirementSkills)
                            {
                                var empSkill = app.Employee.EmployeeSkills.FirstOrDefault(es => es.SkillId == reqSkill.SkillId);
                                var hasSkill = empSkill != null;
                                var meetsRequirement = hasSkill && empSkill!.YearsOfExperience >= reqSkill.MinYearsRequired;
                                
                                <MudItem xs="6" md="3">
                                    <MudPaper Class="pa-2" Elevation="0" Style="background: #f9f9f9;">
                                        <div class="d-flex justify-space-between">
                                            <span>@reqSkill.Skill.SkillName</span>
                                            @if (meetsRequirement)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                            }
                                            else if (hasSkill)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                                            }
                                        </div>
                                        <MudText Typo="Typo.caption" Color="@(meetsRequirement ? Color.Success : hasSkill ? Color.Warning : Color.Error)">
                                            @(hasSkill ? $"{empSkill!.YearsOfExperience} yrs" : "0 yrs") / @reqSkill.MinYearsRequired yrs required
                                        </MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>

                        <!-- Learning Suggestions (if needed) -->
                        @if (app.MatchPercentage < 80)
                        {
                            <MudPaper Class="pa-3 mt-3" Elevation="0" Style="background: #fef3c7;">
                                <MudText Typo="Typo.subtitle2" Style="color: #92400e;">
                                    <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" Class="mr-1" />
                                    Suggested Learning Path:
                                </MudText>
                                <MudList T="string" Dense="true">
                                    <MudListItem Dense="true" Style="color: #92400e; font-size: 13px;">
                                        Complete Python Bootcamp (30 hrs)
                                    </MudListItem>
                                    <MudListItem Dense="true" Style="color: #92400e; font-size: 13px;">
                                        AWS Fundamentals (20 hrs)
                                    </MudListItem>
                                </MudList>
                            </MudPaper>
                        }

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-3">
                            <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                                       OnClick="@(() => UpdateStatus(app.ApplicationId, "Accepted"))"
                                       StartIcon="@Icons.Material.Filled.Check"
                                       Disabled="@(app.Status == "Accepted")">
                                Accept
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                       OnClick="@(() => UpdateStatus(app.ApplicationId, "Shortlisted"))"
                                       StartIcon="@Icons.Material.Filled.List"
                                       Disabled="@(app.Status == "Shortlisted")">
                                Shortlist
                            </MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small"
                                       OnClick="@(() => UpdateStatus(app.ApplicationId, "Rejected"))"
                                       StartIcon="@Icons.Material.Filled.Close"
                                       Disabled="@(app.Status == "Rejected")">
                                Reject
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Comment">
                                Add Feedback
                            </MudButton>
                        </div>

                        @if (app.Status != "Pending")
                        {
                            <MudAlert Severity="@GetStatusSeverity(app.Status)" Dense="true" Class="mt-2">
                                Status: @app.Status
                                @if (app.ReviewedDate.HasValue)
                                {
                                    <span> • Reviewed @app.ReviewedDate.Value.ToString("MMM dd, yyyy")</span>
                                }
                            </MudAlert>
                        }
                    </MudCardContent>
                </MudCard>
            }
        }
        else
        {
            <MudPaper Class="pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Class="mt-3">No applications yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Applications will appear here once employees apply to this requirement.
                </MudText>
            </MudPaper>
        }
    }
}

@code {
    [Parameter]
    public int? RequirementId { get; set; }

    private List<Requirement> _myRequirements = new();
    private List<Application> _applications = new();
    private List<Application> _filteredApplications = new();  // ⭐ For filtered results
    private Dictionary<int, int> _applicationCounts = new();
    private Requirement? _selectedRequirement;
    private int? _selectedRequirementId;
    private bool _isLoading = true;
    private string? _selectedCategory = null;  // ⭐ For tracking selected filter

    protected override async Task OnInitializedAsync()
    {
        await LoadRequirements();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (RequirementId.HasValue && RequirementId != _selectedRequirementId)
        {
            _selectedRequirementId = RequirementId;
            await LoadApplications();
        }
    }

    private async Task LoadRequirements()
    {
        _isLoading = true;

        try
        {
            var employee = await AuthService.GetCurrentEmployeeAsync();
            if (employee == null)
            {
                Snackbar.Add("Not authenticated", Severity.Error);
                return;
            }

            _myRequirements = await RequirementService.GetByManagerAsync(employee.EmployeeId);

            // Load application counts
            await LoadApplicationCounts();

            if (RequirementId.HasValue)
            {
                _selectedRequirementId = RequirementId;
            }
            else if (_myRequirements.Any())
            {
                _selectedRequirementId = _myRequirements.First().RequirementId;
            }

            if (_selectedRequirementId.HasValue)
            {
                await LoadApplications();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading requirements: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadApplicationCounts()
    {
        try
        {
            _applicationCounts.Clear();
            
            foreach (var req in _myRequirements)
            {
                var count = await ApplicationService.GetApplicationCountAsync(req.RequirementId);
                _applicationCounts[req.RequirementId] = count;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading application counts: {ex}");
        }
    }

    private async Task OnRequirementChanged(int? newRequirementId)
    {
        _selectedRequirementId = newRequirementId;
        await LoadApplications();
    }

    private async Task LoadApplications()
    {
        if (!_selectedRequirementId.HasValue) return;

        _isLoading = true;

        try
        {
            _selectedRequirement = await RequirementService.GetByIdAsync(_selectedRequirementId.Value);
            _applications = await ApplicationService.GetByRequirementAsync(_selectedRequirementId.Value);
            _filteredApplications = _applications;  // ⭐ Initialize filtered list
            _selectedCategory = null;  // ⭐ Reset filter when changing requirement
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading applications: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ⭐ NEW: Filter by category
    private void FilterByCategory(string category)
    {
        if (_selectedCategory == category)
        {
            // Click same category again to clear filter
            ClearFilters();
            return;
        }

        _selectedCategory = category;

        _filteredApplications = category switch
        {
            "GoodFit" => _applications.Where(a => a.MatchPercentage >= 80).ToList(),
            "NeedsTraining" => _applications.Where(a => a.MatchPercentage >= 60 && a.MatchPercentage < 80).ToList(),
            "NotRecommended" => _applications.Where(a => a.MatchPercentage < 60).ToList(),
            _ => _applications
        };
    }

    // ⭐ NEW: Clear filters
    private void ClearFilters()
    {
        _selectedCategory = null;
        _filteredApplications = _applications;
    }

    // ⭐ NEW: Helper method for filter style
    private string GetFilterStyle(string category)
    {
        if (_selectedCategory != category)
            return "cursor: pointer;";

        return category switch
        {
            "GoodFit" => "cursor: pointer; border: 2px solid #10b981;",
            "NeedsTraining" => "cursor: pointer; border: 2px solid #f59e0b;",
            "NotRecommended" => "cursor: pointer; border: 2px solid #ef4444;",
            _ => "cursor: pointer;"
        };
    }

    private string GetCategoryName(decimal score)
    {
        return score switch
        {
            >= 80 => "Good Fit",
            >= 60 => "Needs Training",
            _ => "Not Recommended"
        };
    }

    private string GetCategoryDescription(decimal score)
    {
        return score switch
        {
            >= 80 => "Candidate meets or exceeds all mandatory skill requirements with strong experience levels.",
            >= 60 => "Candidate has foundational skills but would benefit from upskilling.",
            _ => "Significant skill gaps exist for this role.",
        };
    }

    private string GetCategoryIcon(decimal score)
    {
        return score switch
        {
            >= 80 => Icons.Material.Filled.CheckCircle,
            >= 60 => Icons.Material.Filled.Warning,
            _ => Icons.Material.Filled.Cancel
        };
    }

    private Color GetCategoryColor(decimal score)
    {
        return score switch
        {
            >= 80 => Color.Success,
            >= 60 => Color.Warning,
            _ => Color.Error
        };
    }

    private string GetCategoryColorHex(decimal score)
    {
        return score switch
        {
            >= 80 => "#10b981",
            >= 60 => "#f59e0b",
            _ => "#ef4444"
        };
    }

    private async Task UpdateStatus(int applicationId, string status)
    {
        try
        {
            await ApplicationService.UpdateStatusAsync(applicationId, status, null);
            await NotificationService.NotifyApplicationStatusAsync(applicationId);
            
            // Refresh
            await LoadApplications();
            
            Snackbar.Add($"Application {status.ToLower()}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating status: {ex.Message}", Severity.Error);
        }
    }

    private (Color, string) GetAvailabilityBadge(string status)
    {
        return status switch
        {
            "Available" => (Color.Success, "Available"),
            "Limited" => (Color.Warning, "Limited"),
            _ => (Color.Error, "Not Available")
        };
    }

    private Color GetScoreColor(decimal score)
    {
        return score switch
        {
            >= 80 => Color.Success,
            >= 60 => Color.Warning,
            _ => Color.Error
        };
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Open" => Color.Success,
            "Closed" => Color.Default,
            "Filled" => Color.Info,
            "On Hold" => Color.Warning,
            _ => Color.Default
        };
    }

    private Severity GetStatusSeverity(string status)
    {
        return status switch
        {
            "Accepted" => Severity.Success,
            "Shortlisted" => Severity.Info,
            "Rejected" => Severity.Error,
            _ => Severity.Normal
        };
    }

    private string GetTimeAgo(DateTime date)
    {
        var diff = DateTime.Now - date;
        if (diff.TotalHours < 1) return "just now";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hours ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays} days ago";
        return date.ToString("MMM dd");
    }
}