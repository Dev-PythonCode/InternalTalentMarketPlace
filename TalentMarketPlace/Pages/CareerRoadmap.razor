@page "/career-roadmap"
@inject IEmployeeService EmployeeService
@inject IRequirementService RequirementService
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject HttpClient Http
@using System.Net.Http.Json
@using System.Text.Json
@using System.Text.Json.Serialization
@using TalentMarketPlace.Models

<MudGrid Class="mb-4">
    <MudItem xs="12" md="8">
        <MudText Typo="Typo.h4">Career Roadmap</MudText>
        <MudText Typo="Typo.body1" Color="Color.Primary">
            Get personalized career guidance based on your skills and goals
        </MudText>
    </MudItem>
    <MudItem xs="12" md="4" Class="d-flex align-end justify-end">
        <MudSwitch T="bool" @bind-Checked="_useExternalAI" Color="Color.Primary" Label="Use External AI" 
               Class="ml-auto" ThumbIcon="@(_useExternalAI ? Icons.Material.Filled.Cloud : Icons.Material.Filled.Computer)" />
        @if (_useExternalAI)
        {
            <MudTooltip Text="Powered by Claude AI">
                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                    <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Size="Size.Small" />
                </MudChip>
            </MudTooltip>
        }
    </MudItem>
</MudGrid>

@if (_currentEmployee != null)
{
    <!-- Current Profile Summary -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" Color="Color.Info"/>
                Your Current Profile
            </MudText>
            <MudGrid>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle1" Color="Color.Warning">Total Experience</MudText>
                    <MudText Typo="Typo.h6">@_currentEmployee.YearsOfExperience years</MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle1" Color="Color.Warning">Skills</MudText>
                    <MudText Typo="Typo.h6">@_mySkills.Count skills</MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle1" Color="Color.Warning">Current Role</MudText>
                    <MudText Typo="Typo.h6">@_currentEmployee.Designation</MudText>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudText Typo="Typo.subtitle1" Color="Color.Warning">Location</MudText>
                    <MudText Typo="Typo.h6">@_currentEmployee.Location</MudText>
                </MudItem>
            </MudGrid>
            
            @if (_mySkills.Any())
            {
                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">Your Skills:</MudText>
                <div>
                    @foreach (var skill in _mySkills.Take(10))
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text">
                            @skill.Skill.SkillName (@skill.YearsOfExperience yr)
                        </MudChip>
                    }
                    @if (_mySkills.Count > 10)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">
                            +@(_mySkills.Count - 10) more
                        </MudChip>
                    }
                </div>
            }
        </MudCardContent>
    </MudCard>

    <!-- Career Goal Input -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="mr-2" Color="Color.Info"/>
                What's Your Career Goal?
            </MudText>
            
            <MudTextField @bind-Value="_careerGoalPrompt" 
                          @ref="_careerGoalInput"
                          Label="Describe your career aspirations" 
                          Variant="Variant.Outlined"
                          Lines="3"
                          Placeholder="Example: I want to become a Cloud Architect specializing in AWS and DevOps"
                          Class="mb-3" />
            
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       OnClick="GenerateRoadmap" 
                       Disabled="_isGenerating"
                       StartIcon="@Icons.Material.Filled.AutoAwesome">
                @if (_isGenerating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>@(_useExternalAI ? "Consulting AI..." : "Analyzing...")</span>
                }
                else
                {
                    <span>Generate My Roadmap</span>
                }
            </MudButton>
            
            @if (_useExternalAI)
            {
                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                    <MudIcon Icon="@Icons.Material.Filled.Cloud" Size="Size.Small" Class="mr-2" />
                    Using external AI for comprehensive career guidance
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>

    @if (_roadmapGenerated)
    {
        <!-- AI Generated Insights (only for external AI) -->
        @if (_useExternalAI && !string.IsNullOrEmpty(_aiInsights))
        {
            <MudCard Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Psychology" Class="mr-2" />
                        AI Career Insights
                    </MudText>
                    <MudPaper Class="pa-3" Elevation="0" Style="background: #f0f7ff;">
                        <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@_aiInsights</MudText>
                    </MudPaper>
                </MudCardContent>
            </MudCard>
        }

        <!-- Skills Gap Analysis -->
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Class="mr-2" Color="Color.Info"/>
                    Skills Gap Analysis
                </MudText>
                <MudButton Variant="Variant.Text" Size="Size.Small"
                           OnClick="@(() => _expandSkillGap = !_expandSkillGap)"
                           EndIcon="@(_expandSkillGap ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                           Class="mb-3">
                    @(_expandSkillGap ? "Collapse" : "Expand")
                </MudButton>

                @if (_expandSkillGap)
                {
                
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: #e8f5e9;">
                            <MudText Typo="Typo.subtitle2" Style="color: #2e7d32;">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" />
                                Skills You Have (@_skillsYouHave.Count)
                            </MudText>
                            @if (_skillsYouHave.Any())
                            {
                                <MudList T="string" Dense="true">
                                    @foreach (var skill in _skillsYouHave)
                                    {
                                        <MudListItem T="string" Dense="true">
                                            <MudText Typo="Typo.body2">‚úì @skill</MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                                    Add skills to your profile first
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: #fff3e0;">
                            <MudText Typo="Typo.subtitle2" Style="color: #e65100;">
                                <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Small" />
                                Skills to Learn (@_skillsToLearn.Count)
                            </MudText>
                            @if (_skillsToLearn.Any())
                            {
                                <MudList T="string" Dense="true">
                                    @foreach (var skill in _skillsToLearn)
                                    {
                                        <MudListItem T="string" Dense="true">
                                            <MudText Typo="Typo.body2">‚Üí @skill</MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                                    You're all set for your current goal!
                                </MudText>
                            }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                }
            </MudCardContent>
        </MudCard>

        @if (_roadmapData != null && (_roadmapData.LearningPath?.Any() ?? false))
        {
            <!-- Structured Learning Path Phases -->
            <MudCard Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.DynamicForm" Class="mr-2" Color="Color.Info"/>
                        Structured Learning Path - @_roadmapData.MatchedProfile
                    </MudText>
                    <MudButton Variant="Variant.Text" Size="Size.Small"
                               OnClick="@(() => _expandLearningPath = !_expandLearningPath)"
                               EndIcon="@(_expandLearningPath ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                               Class="mb-3">
                        @(_expandLearningPath ? "Collapse" : "Expand")
                    </MudButton>

                    @if (_expandLearningPath)
                    {
                    
                    <MudGrid Class="mb-4">
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="0" Style="background: #e3f2fd;">
                                <MudText Typo="Typo.subtitle2" Style="color: #1565c0;">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                    Timeline
                                </MudText>
                                <MudText Typo="Typo.h6" Class="mt-1">
                                    @(_roadmapData.TimelineWeeks) weeks
                                </MudText>
                                <MudText Typo="Typo.caption">@_roadmapData.EffortPerWeek</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="0" Style="background: #f3e5f5;">
                                <MudText Typo="Typo.subtitle2" Style="color: #6a1b9a;">
                                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" />
                                    Career Path
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mt-1">@_roadmapData.CareerPath</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                    }

                    <!-- Learning Phases Timeline -->
                    <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.School" Class="mr-2" Color="Color.Warning"/>
                        Phase-by-Phase Learning Guide
                    </MudText>
                    
                    <MudTimeline TimelinePosition="TimelinePosition.Start">
                        @{
                            var phaseNumber = 1;
                            var colors = new[] { Color.Success, Color.Primary, Color.Info, Color.Warning, Color.Error, Color.Secondary, Color.Tertiary };
                            foreach (var phase in _roadmapData.LearningPath)
                            {
                                var phaseColor = colors[(phaseNumber - 1) % colors.Length];
                                var phaseStyle = $"border-left: 4px solid; border-left-color: var(--mud-palette-{phaseColor.ToString().ToLower()});";
                                
                                <MudTimelineItem Color="phaseColor" Size="Size.Small" Elevation="2">
                                    <ItemOpposite>
                                        <MudText Typo="Typo.caption" Style="font-weight: 600;">
                                            Phase @phaseNumber
                                        </MudText>
                                    </ItemOpposite>
                                    <ItemContent>
                                        <MudPaper Class="pa-3" Elevation="1">
                                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                                                @phase
                                            </MudText>
                                        </MudPaper>
                                    </ItemContent>
                                </MudTimelineItem>
                                phaseNumber++;
                            }
                        }
                    </MudTimeline>

                    @if (_roadmapData.PrerequisiteSkills?.Any() ?? false)
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2" Style="color: #d32f2f;">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                            Prerequisites
                        </MudText>
                        <div>
                            @foreach (var prereq in _roadmapData.PrerequisiteSkills)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text">
                                    @prereq
                                </MudChip>
                            }
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        }

        <!-- Recommended Courses -->
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.MenuBook" Class="mr-2" Color="Color.Info"/>
                    Recommended Learning Path (@_recommendedCourses.Count courses)
                </MudText>
                <MudButton Variant="Variant.Text" Size="Size.Small"
                           OnClick="@(() => _expandRecommendedCourses = !_expandRecommendedCourses)"
                           EndIcon="@(_expandRecommendedCourses ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                           Class="mb-3">
                    @(_expandRecommendedCourses ? "Collapse" : "Expand")
                </MudButton>

                @if (_expandRecommendedCourses)
                {
                
                @if (_recommendedCourses.Any())
                {
                    @foreach (var course in _recommendedCourses)
                    {
                        <MudPaper Class="pa-3 mb-3" Elevation="1">
                            <MudGrid>
                                <MudItem xs="12" md="8">
                                    <MudText Typo="Typo.h6">@course.Title</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
                                        @course.Provider ‚Ä¢
                                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        @course.Duration ‚Ä¢
                                        <MudIcon Icon="@Icons.Material.Filled.BarChart" Size="Size.Small" />
                                        @course.Level
                                    </MudText>
                                    <MudText Typo="Typo.body2">@course.Description</MudText>
                                    <div class="mt-2">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">
                                            @course.TargetSkill
                                        </MudChip>
                                    </div>
                                </MudItem>
                                <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                                    <div>
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                                                   Href="@course.Url" Target="_blank"
                                                   StartIcon="@Icons.Material.Filled.OpenInNew">
                                            Start Learning
                                        </MudButton>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">
                        No specific courses found. Try refining your career goal.
                    </MudAlert>
                }
                }
            </MudCardContent>
        </MudCard>

        <!-- Matching Job Opportunities -->
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Work" Class="mr-2" Color="Color.Info"/>
                    Opportunities Aligned with Your Goal
                </MudText>
                <MudButton Variant="Variant.Text" Size="Size.Small"
                           OnClick="@(() => _expandOpportunities = !_expandOpportunities)"
                           EndIcon="@(_expandOpportunities ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                           Class="mb-3">
                    @(_expandOpportunities ? "Collapse" : "Expand")
                </MudButton>

                @if (_expandOpportunities)
                {
                
                @if (_matchingJobs.Any())
                {
                    @foreach (var job in _matchingJobs)
                    {
                        <MudPaper Class="pa-3 mb-3" Elevation="1">
                            <MudGrid>
                                <MudItem xs="12" md="9">
                                    <MudText Typo="Typo.h6">@job.Title</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" />
                                        @(job.Team?.TeamName ?? "Any Team") ‚Ä¢
                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" />
                                        @(job.Location ?? "Any Location") ‚Ä¢
                                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                                        @job.Duration
                                    </MudText>
                                    <div class="mt-2">
                                        @foreach (var skill in job.RequirementSkills.Take(5))
                                        {
                                            var hasSkill = _skillsToLearn.Contains(skill.Skill.SkillName) || 
                                                          _skillsYouHave.Contains(skill.Skill.SkillName);
                                            <MudChip T="string" Size="Size.Small" 
                                                     Color="@(hasSkill ? Color.Success : Color.Default)">
                                                @skill.Skill.SkillName - @skill.MinYearsRequired yr
                                                @if (hasSkill)
                                                {
                                                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" />
                                                }
                                            </MudChip>
                                        }
                                    </div>
                                </MudItem>
                                <MudItem xs="12" md="3" Class="d-flex align-center justify-end">
                                    <div>
                                        <MudText Typo="Typo.h4" Color="@GetMatchColor(job.MatchPercentage)">
                                            @job.MatchPercentage%
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Match</MudText>
                                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                                                   Size="Size.Small" Class="mt-2"
                                                   OnClick="@(() => ViewJob(job.RequirementId))">
                                            View Details
                                        </MudButton>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }
                }
                else
                {
                    <MudPaper Class="pa-4 text-center" Elevation="0" Style="background: #fef3c7;">
                        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Warning" />
                        <MudText Typo="Typo.h6" Class="mt-2">No jobs available for your expected skills</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @if (_skillsToLearn.Any())
                            {
                                <span>Focus on learning: @string.Join(", ", _skillsToLearn.Take(3))</span>
                            }
                            else
                            {
                                <span>Try a different career goal or check back later for new opportunities</span>
                            }
                        </MudText>
                    </MudPaper>
                }
                }
            </MudCardContent>
        </MudCard>

        <!-- Timeline Roadmap removed; using Structured Learning Path above -->
    }
}

@code {
    private Employee? _currentEmployee;
    private List<EmployeeSkill> _mySkills = new();
    private string _careerGoalPrompt = "";
    private MudTextField<string> _careerGoalInput;
    private bool _isGenerating = false;
    private bool _roadmapGenerated = false;
    private bool _useExternalAI = false;

    // Analysis Results
    private List<string> _skillsYouHave = new();
    private List<string> _skillsToLearn = new();
    private List<CourseRecommendation> _recommendedCourses = new();
    private List<JobOpportunity> _matchingJobs = new();
    private string _aiInsights = "";
    // Roadmap + dynamic skills
    private RoadmapResponse? _roadmapData;
    private List<string> _commonSkills = new();
    // Expand/collapse controls for UI sections
    private bool _expandSkillGap = true;
    private bool _expandLearningPath = true;
    private bool _expandRecommendedCourses = true;
    private bool _expandOpportunities = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentEmployee = await AuthService.GetCurrentEmployeeAsync();
            
            if (_currentEmployee != null)
            {
                _mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee.EmployeeId);
            }
            // Load dynamic skills from Python API
            await LoadCommonSkills();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
    }


    private async Task GenerateRoadmap()
    {
        if (string.IsNullOrWhiteSpace(_careerGoalPrompt))
        {
            Snackbar.Add("Please describe your career goal", Severity.Warning);
            return;
        }

        _isGenerating = true;
        
        try
        {
            if (_useExternalAI)
            {
                // Use External AI (Claude)
                await GenerateRoadmapWithExternalAI();
            }
            else
            {
                // Use Internal Database
                await GenerateRoadmapWithInternalData();
            }
            
            _roadmapGenerated = true;
            Snackbar.Add("Career roadmap generated!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating roadmap: {ex.Message}", Severity.Error);
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task GenerateRoadmapWithInternalData()
    {
        try
        {
            await Task.Delay(500); // Brief UI feedback
            // ‚≠ê STEP 1: Prefer Python roadmap endpoint which returns recommended skills and parsed data
            var roadmapUrl = "http://localhost:5000/career_roadmap";
            var roadmapResp = await Http.PostAsJsonAsync(roadmapUrl, new { prompt = _careerGoalPrompt });

            if (roadmapResp.IsSuccessStatusCode)
            {
                var roadmap = await roadmapResp.Content.ReadFromJsonAsync<RoadmapResponse>();
                var recommendedSkills = roadmap?.RecommendedSkills ?? new List<string>();

                Console.WriteLine($"‚úÖ Roadmap API returned {recommendedSkills.Count} core skills");

                // Analyze current skills
                _skillsYouHave = _mySkills.Select(s => s.Skill.SkillName).ToList();

                // Find skills gap using only recommended/core skills
                _skillsToLearn = recommendedSkills
                    .Where(skill => !_skillsYouHave.Any(s => s.Equals(skill, StringComparison.OrdinalIgnoreCase)))
                    .ToList();

                _recommendedCourses = GenerateCourseRecommendations(_skillsToLearn);
                
                // ‚≠ê NEW: Use enhanced skill-based requirement filtering (70% match threshold)
                await LoadMatchingJobsBySkillsEnhanced(recommendedSkills);
                
                _aiInsights = roadmap?.Notes ?? "";
                _roadmapData = roadmap;
                return;
            }

            // Fallback: call parse endpoint (legacy)
            var pythonApiUrl = "http://localhost:5000/parse"; // Your Python API
            var parseResponse = await Http.PostAsJsonAsync(pythonApiUrl, new { query = _careerGoalPrompt });

            if (parseResponse.IsSuccessStatusCode)
            {
                var parsedResult = await parseResponse.Content.ReadFromJsonAsync<PythonParseResponse>();

                var mentionedSkills = parsedResult?.Parsed?.Skills ?? new List<string>();
                var categorySkills = parsedResult?.Parsed?.CategorySkills ?? new List<string>();
                var allMentioned = mentionedSkills.Concat(categorySkills).Distinct().ToList();

                _skillsYouHave = _mySkills.Select(s => s.Skill.SkillName).ToList();
                _skillsToLearn = allMentioned
                    .Where(skill => !_skillsYouHave.Any(s => s.Equals(skill, StringComparison.OrdinalIgnoreCase)))
                    .ToList();

                _recommendedCourses = GenerateCourseRecommendations(_skillsToLearn);
                await LoadMatchingJobsForSkills(allMentioned);
            }
            else
            {
                // Fallback to basic keyword extraction if Python API fails
                Console.WriteLine("‚ö†Ô∏è Python API unavailable, using fallback");
                _skillsYouHave = _mySkills.Select(s => s.Skill.SkillName).ToList();
                _skillsToLearn = AnalyzeSkillsGap(_careerGoalPrompt);
                _recommendedCourses = GenerateCourseRecommendations(_skillsToLearn);
                await LoadMatchingJobsForGoal();
            }
            
            _aiInsights = ""; // No AI insights for internal mode
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in internal data generation: {ex}");
            Snackbar.Add("Error analyzing career goal. Please try again.", Severity.Error);
        }
    }

    private async Task GenerateRoadmapWithExternalAI()
    {
        try
        {
            // ‚≠ê OPTION A: If you have Claude API key, use it
            // You would need to add it to appsettings.json and inject IConfiguration
            
            // For now, show a message and fallback to internal
            Snackbar.Add("External AI requires API key configuration. Using internal analysis.", Severity.Info);
            await GenerateRoadmapWithInternalData();
            
            // ‚≠ê OPTION B: Add AI insights using your Python API + prompt engineering
            // You could enhance your Python API with a /suggest-career endpoint
            // that uses the parsed skills to generate structured career advice
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå External AI error: {ex}");
            await GenerateRoadmapWithInternalData();
        }
    }

    private async Task LoadMatchingJobsForSkills(List<string> targetSkills)
    {
        try
        {
            // Get all open requirements
            var allJobs = await RequirementService.GetAllAsync(true);
            
            _matchingJobs = new List<JobOpportunity>();
            
            foreach (var job in allJobs)
            {
                var jobSkills = job.RequirementSkills?.Select(rs => rs.Skill.SkillName).ToList() ?? new();
                
                // ‚≠ê Check if job requires ANY of the skills mentioned in career goal
                var hasRelevantSkills = targetSkills.Any(targetSkill => 
                    jobSkills.Any(jobSkill => 
                        jobSkill.Equals(targetSkill, StringComparison.OrdinalIgnoreCase)));
                
                if (hasRelevantSkills)
                {
                    var matchResult = await EmployeeService.CalculateMatchScoreAsync(
                        _currentEmployee!.EmployeeId, 
                        job.RequirementId);
                    
                    _matchingJobs.Add(new JobOpportunity
                    {
                        RequirementId = job.RequirementId,
                        Title = job.Title,
                        Team = job.Team,
                        Location = job.Location,
                        Duration = job.Duration,
                        RequirementSkills = job.RequirementSkills?.ToList() ?? new(),
                        MatchPercentage = (int)matchResult.MatchPercentage
                    });
                    
                    Console.WriteLine($"‚úÖ Matched job: {job.Title} ({matchResult.MatchPercentage}%)");
                }
            }
            
            // Sort by match percentage
            _matchingJobs = _matchingJobs
                .OrderByDescending(j => j.MatchPercentage)
                .Take(5)
                .ToList();
            
            Console.WriteLine($"üìã Total matching jobs: {_matchingJobs.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading jobs: {ex}");
        }
    }

    public class PythonParseResponse
    {
        public ParsedData? Parsed { get; set; }
    }

    public class ParsedData
    {
        public List<string> Skills { get; set; } = new();
        public List<string> Categories { get; set; } = new();
        [JsonPropertyName("category_skills")]
        public List<string> CategorySkills { get; set; } = new();
    }

    private List<string> AnalyzeSkillsGap(string goal)
    {
        // Use common skills loaded from API, or return empty if not available
        // This delegates to the Python API to identify relevant skills
        var skillsToLearn = ExtractSkillsFromGoal(goal);
        
        // If no skills found in database, return empty list
        // User should rely on Python API or update their skills database
        return skillsToLearn;
    }

    private List<CourseRecommendation> GenerateCourseRecommendations(List<string> skills)
    {
        var courses = new List<CourseRecommendation>();

        foreach (var skill in skills.Take(5))
        {
            courses.Add(new CourseRecommendation
            {
                Title = $"Complete {skill} Course",
                Provider = GetProviderForSkill(skill),
                TargetSkill = skill,
                Duration = "40 hours",
                Level = "Intermediate",
                Description = $"Master {skill} from fundamentals to advanced concepts with hands-on projects",
                Url = GetCourseUrl(skill)
            });
        }

        return courses;
    }

    private string GetProviderForSkill(string skill)
    {
        // Generic provider mapping - prefer Coursera as default
        // For specific providers, consider fetching from a learning resource API
        return "Coursera / Udemy";
    }

    private string GetCourseUrl(string skill)
    {
        // Generic URL that searches for the skill
        // Return Coursera search URL - users can search for specific courses
        return $"https://www.coursera.org/search?query={Uri.EscapeDataString(skill)}";
    }

    private async Task LoadMatchingJobsForGoal()
    {
        try
        {
            // Get all open requirements
            var allJobs = await RequirementService.GetAllAsync(true);
            
            // Extract skill keywords from goal
            var goalSkills = ExtractSkillsFromGoal(_careerGoalPrompt);
            
            // Filter jobs that have ANY of the mentioned skills
            _matchingJobs = new List<JobOpportunity>();
            
            foreach (var job in allJobs)
            {
                var jobSkills = job.RequirementSkills?.Select(rs => rs.Skill.SkillName.ToLower()).ToList() ?? new();
                
                // Check if job has any of the goal skills or skills to learn
                var hasRelevantSkills = goalSkills.Any(gs => jobSkills.Any(js => js.Contains(gs.ToLower()))) ||
                                       _skillsToLearn.Any(stl => jobSkills.Any(js => js.Contains(stl.ToLower())));
                
                if (hasRelevantSkills)
                {
                    var matchResult = await EmployeeService.CalculateMatchScoreAsync(
                        _currentEmployee!.EmployeeId, 
                        job.RequirementId);
                    
                    _matchingJobs.Add(new JobOpportunity
                    {
                        RequirementId = job.RequirementId,
                        Title = job.Title,
                        Team = job.Team,
                        Location = job.Location,
                        Duration = job.Duration,
                        RequirementSkills = job.RequirementSkills?.ToList() ?? new(),
                        MatchPercentage = (int)matchResult.MatchPercentage
                    });
                }
            }
            
            // Sort by match percentage
            _matchingJobs = _matchingJobs
                .OrderByDescending(j => j.MatchPercentage)
                .Take(5)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading jobs: {ex}");
        }
    }

    /// <summary>
    /// Enhanced requirement matching using C# backend skill-based filtering.
    /// Filters requirements that have >= 70% match with core skills from career path.
    /// </summary>
    private async Task LoadMatchingJobsBySkillsEnhanced(List<string> coreSkills)
    {
        try
        {
            if (!coreSkills.Any())
            {
                _matchingJobs = new List<JobOpportunity>();
                Console.WriteLine("‚ö†Ô∏è No core skills provided for requirement matching");
                return;
            }

            Console.WriteLine($"üîç Filtering requirements for {coreSkills.Count} core skills: {string.Join(", ", coreSkills)}");

            // ‚≠ê Call the enhanced C# backend method that filters by skill match (>= 70%)
            var matchedRequirements = await RequirementService.FindBySkillsAsync(coreSkills, minimumMatchPercentage: 70);

            Console.WriteLine($"‚úÖ Found {matchedRequirements.Count} requirements matching >= 70% of core skills");

            _matchingJobs = new List<JobOpportunity>();

            foreach (var requirement in matchedRequirements)
            {
                try
                {
                    var matchResult = await EmployeeService.CalculateMatchScoreAsync(
                        _currentEmployee!.EmployeeId,
                        requirement.RequirementId);

                    _matchingJobs.Add(new JobOpportunity
                    {
                        RequirementId = requirement.RequirementId,
                        Title = requirement.Title,
                        Team = requirement.Team,
                        Location = requirement.Location,
                        Duration = requirement.Duration,
                        RequirementSkills = requirement.RequirementSkills?.ToList() ?? new(),
                        MatchPercentage = (int)matchResult.MatchPercentage
                    });
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚ö†Ô∏è Error calculating match score for requirement {requirement.RequirementId}: {ex.Message}");
                }
            }

            // Sort by match percentage, take top 10
            _matchingJobs = _matchingJobs
                .OrderByDescending(j => j.MatchPercentage)
                .Take(10)
                .ToList();

            Console.WriteLine($"üìã Displaying {_matchingJobs.Count} job opportunities matching career path skills");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in enhanced skill-based requirement filtering: {ex}");
            // Fallback to basic matching
            await LoadMatchingJobsForSkills(coreSkills);
        }
    }

    private List<string> ExtractSkillsFromGoal(string goal)
    {
        var found = new List<string>();
        var goalLower = goal.ToLower();

        foreach (var skill in _commonSkills)
        {
            if (!string.IsNullOrWhiteSpace(skill) && goalLower.Contains(skill.ToLower()))
            {
                found.Add(skill);
            }
        }

        return found.Distinct().ToList();
    }

    private Color GetMatchColor(int percentage)
    {
        return percentage switch
        {
            >= 80 => Color.Success,
            >= 60 => Color.Warning,
            _ => Color.Error
        };
    }

    private void ViewJob(int requirementId)
    {
        Navigation.NavigateTo("/job-board");
    }

    private async Task LoadCommonSkills()
    {
        try
        {
            var response = await Http.GetAsync("http://localhost:5000/skills");
            
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var skillsResponse = JsonSerializer.Deserialize<SkillsResponse>(json);
                
                if (skillsResponse?.Skills != null)
                {
                    _commonSkills = skillsResponse.Skills;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading skills from API: {ex.Message}");
            // If API fails, skills will remain empty - no fallback to hardcoded values
            // User should configure Python API or the skills endpoint
            _commonSkills = new List<string>();
        }
    }
    public class CourseRecommendation
    {
        public string Title { get; set; } = "";
        public string Provider { get; set; } = "";
        public string TargetSkill { get; set; } = "";
        public string Duration { get; set; } = "";
        public string Level { get; set; } = "";
        public string Description { get; set; } = "";
        public string Url { get; set; } = "";
    }

    public class JobOpportunity
    {
        public int RequirementId { get; set; }
        public string Title { get; set; } = "";
        public Team? Team { get; set; }
        public string? Location { get; set; }
        public string Duration { get; set; } = "";
        public List<RequirementSkill> RequirementSkills { get; set; } = new();
        public int MatchPercentage { get; set; }
    }

    public class ClaudeResponse
    {
        public List<ClaudeContent>? Content { get; set; }
    }

    public class ClaudeContent
    {
        public string? Text { get; set; }
    }

    public class SkillsResponse
    {
        [JsonPropertyName("total_skills")]
        public int? TotalSkills { get; set; }

        [JsonPropertyName("skills")]
        public List<string>? Skills { get; set; }

        [JsonPropertyName("categories")]
        public List<string>? Categories { get; set; }
    }
}