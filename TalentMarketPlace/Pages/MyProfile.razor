@page "/my-profile"
@inject IEmployeeService EmployeeService
@inject ISkillService SkillService
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject IDialogService _dialogService

<MudText Typo="Typo.h4" Class="mb-2">My Profile</MudText>
<MudText Typo="Typo.body1" Color="Color.Primary" Class="mb-4">Manage your skills and experience</MudText>

@if (_currentEmployee != null)
{
    <!-- Employee Info Card -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid> 
                <MudItem xs="12" md="1" Class="d-flex justify-center">
                    <MudAvatar Size="Size.Large" Color="Color.Warning">
                        @_currentEmployee.FullName[0]
                    </MudAvatar>
                </MudItem>
                <MudItem xs="12" md="11">
                    <MudText Typo="Typo.h5" Color="Color.Warning"><strong>@_currentEmployee.FullName</strong></MudText>
                    <MudText Typo="Typo.body1" Color="Color.Surface">@_currentEmployee.Email</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Surface">
                        @_currentEmployee.Designation • @(_currentEmployee.Team?.TeamName ?? "No Team") • @_currentEmployee.Location
                    </MudText>
                    @if (_totalExperienceDecimal > 0)
                    {
                        <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Info">
                            <MudIcon Icon="@Icons.Material.Filled.WorkHistory" Size="Size.Small" Class="mr-1" />
                            <strong>@FormatTotalExperience() total experience</strong>
                        </MudText>
                    }
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Edit Total Experience Section -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" />
                Update Total Experience
            </MudText>
            
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudNumericField T="int" Label="Years" @bind-Value="_totalExpYears" 
                                     Variant="Variant.Outlined" Min="0" Max="50" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField T="int" Label="Months" @bind-Value="_totalExpMonths" 
                                     Variant="Variant.Outlined" Min="0" Max="11" />
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled" Color="Color.Success" 
                               OnClick="UpdateTotalExperience" FullWidth="true"
                               StartIcon="@Icons.Material.Filled.Save">
                        Save
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Add Skill & Availability Section -->
    <MudCard Class="mb-4">
        <MudCardContent>
            <MudGrid>
                <!-- Left Half: Add/Edit Skill -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@(_editingSkill != null ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-2" />
                        @(_editingSkill != null ? $"Edit Skill: {_editingSkill.Skill.SkillName}" : "Add Skill")
                    </MudText>
                    
                    @if (_editingSkill == null)
                    {
                        <MudSelect T="int?" Label="Skill *" @bind-Value="_newSkillId" 
                                   Variant="Variant.Outlined" Class="mb-3"
                                   HelperText="Select a skill you want to add">
                            @foreach (var skill in _availableSkills.Where(s => !_mySkills.Any(ms => ms.SkillId == s.SkillId)))
                            {
                                <MudSelectItem T="int?" Value="@skill.SkillId">
                                    @skill.SkillName
                                    @if (skill.Category != null)
                                    {
                                        <span style="color: gray; font-size: 0.8em;"> (@skill.Category.CategoryName)</span>
                                    }
                                </MudSelectItem>
                            }
                        </MudSelect>
                    }
                    else
                    {
                        <MudTextField T="string" Label="Skill" Value="@_editingSkill.Skill.SkillName" 
                                     ReadOnly="true" Variant="Variant.Outlined" Class="mb-3" />
                    }
                    
                    <MudNumericField T="decimal" Label="Years of Experience *" @bind-Value="_newSkillYears" 
                                     Variant="Variant.Outlined" Step="0.5M" Min="0" Max="50" Class="mb-3" />
                    
                    <MudSelect T="string" Label="Proficiency Level *" @bind-Value="_newSkillLevel" 
                               Variant="Variant.Outlined" Class="mb-3">
                        <MudSelectItem T="string" Value="@("Beginner")">Beginner</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Intermediate")">Intermediate</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Advanced")">Advanced</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Expert")">Expert</MudSelectItem>
                    </MudSelect>
                    
                    <MudDatePicker Label="Last Used Date" @bind-Date="_newSkillLastUsed" 
                                   Variant="Variant.Outlined" Class="mb-3" />
                    
                    <div Class="d-flex gap-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Info" 
                                   OnClick="@(_editingSkill != null ? (Func<Task>)SaveEditedSkillInline : AddSkill)" 
                                   FullWidth="true" StartIcon="@(_editingSkill != null ? Icons.Material.Filled.Save : Icons.Material.Filled.Add)">
                            @(_editingSkill != null ? "Save Changes" : "Add Skill")
                        </MudButton>
                        @if (_editingSkill != null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" 
                                       OnClick="CancelEdit" StartIcon="@Icons.Material.Filled.Close">
                                Cancel
                            </MudButton>
                        }
                    </div>
                </MudItem>

                <!-- Right Half: Availability Status -->
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.EventAvailable" Class="mr-2" />
                        Availability Status *
                    </MudText>
                    
                    <MudRadioGroup T="string" @bind-SelectedOption="_availabilityStatus" Style="display: flex; flex-direction: column;">
                        <MudRadio T="string" Option="@("Available")" Color="Color.Success" Class="mb-3">
                            <div>
                                <MudText Typo="Typo.body1"><strong>Available</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Info">
                                    Ready for new assignments
                                </MudText>
                            </div>
                        </MudRadio>
                        <MudRadio T="string" Option="@("Limited")" Color="Color.Warning" Class="mb-3">
                            <div>
                                <MudText Typo="Typo.body1"><strong>Limited</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Info">
                                    Available part-time or for specific roles
                                </MudText>
                            </div>
                        </MudRadio>
                        <MudRadio T="string" Option="@("Not Available")" Color="Color.Error" Class="mb-3">
                            <div>
                                <MudText Typo="Typo.body1"><strong>Not Available</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Info">
                                    Currently not looking for opportunities
                                </MudText>
                            </div>
                        </MudRadio>
                    </MudRadioGroup>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                               OnClick="UpdateAvailability" Class="mt-3" FullWidth="true">
                        Update Availability Status
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>
}

<!-- Current Skills -->
<MudCard Class="mt-4">
    <MudCardContent>
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" />
            My Skills (@_mySkills.Count)
        </MudText>
        
        @if (_mySkills.Any())
        {
            <MudSimpleTable Dense="true" Hover="true" Striped="true">
                <thead>
                    <tr>
                        <th>Skill</th>
                        <th>Years</th>
                        <th>Level</th>
                        <th>Last Used</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var skill in _mySkills)
                    {
                        <tr>
                            <td><strong>@skill.Skill.SkillName</strong></td>
                            <td>@skill.YearsOfExperience</td>
                            <td>
                                <MudChip T="string" Size="Size.Small" Color="@GetLevelColor(skill.ProficiencyLevel)">
                                    @skill.ProficiencyLevel
                                </MudChip>
                            </td>
                            <td>@(skill.LastUsedDate?.ToString("MMM yyyy") ?? "-")</td>
                            <td>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" 
                                         Color="@(skill.Source == "Auto" ? Color.Info : Color.Default)">
                                    @skill.Source
                                </MudChip>
                            </td>
                            <td>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" 
                                               Color="Color.Primary" OnClick="@(() => EditSkill(skill))" 
                                               Title="Edit skill" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" 
                                               Color="Color.Error" OnClick="@(() => DeleteSkill(skill))" 
                                               Title="Delete skill" />
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
        else
        {
            <MudPaper Class="pa-4 text-center" Elevation="0" Style="background: #f5f5f5;">
                <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.body1" Class="mt-2">No skills added yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Add your first skill using the form above
                </MudText>
            </MudPaper>
        }
    </MudCardContent>
</MudCard>

@code {
    private Employee? _currentEmployee;
    private List<Skill> _availableSkills = new();
    private List<EmployeeSkill> _mySkills = new();
    
    // Total Experience
    private int _totalExpYears = 0;
    private int _totalExpMonths = 0;
    private decimal _totalExperienceDecimal = 0;
    
    // Add Skill
    private int? _newSkillId;
    private decimal _newSkillYears = 1;
    private string _newSkillLevel = "Intermediate";
    private DateTime? _newSkillLastUsed = DateTime.Now;
    private EmployeeSkill? _editingSkill = null;  // ⭐ Track if editing
    
    // Availability
    private string _availabilityStatus = "Available";
    
    // Edit Skill Dialog (deprecated - now using inline form)
    private bool _editDialogOpen = false;
    private decimal _editSkillYears;
    private string _editSkillLevel = "Intermediate";
    private DateTime? _editSkillLastUsed;
    
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _currentEmployee = await AuthService.GetCurrentEmployeeAsync();
            
            _availableSkills = await SkillService.GetAllAsync();
            Console.WriteLine($"✅ Loaded {_availableSkills.Count} skills");
            
            if (_currentEmployee != null)
            {
                _mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee.EmployeeId);
                _availabilityStatus = _currentEmployee.AvailabilityStatus ?? "Available";
                
                // Load total experience
                _totalExperienceDecimal = _currentEmployee.YearsOfExperience;
                _totalExpYears = (int)_totalExperienceDecimal;
                _totalExpMonths = (int)((_totalExperienceDecimal - _totalExpYears) * 12);
                
                Console.WriteLine($"✅ Total Experience: {_totalExpYears} years, {_totalExpMonths} months");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error in OnInitializedAsync: {ex}");
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateTotalExperience()
    {
        if (_currentEmployee == null) return;

        // Validation
        if (_totalExpYears == 0 && _totalExpMonths == 0)
        {
            Snackbar.Add("Please enter your total experience", Severity.Warning);
            return;
        }

        if (_totalExpMonths > 11)
        {
            Snackbar.Add("Months must be between 0 and 11", Severity.Warning);
            return;
        }

        try
        {
            // Calculate decimal (e.g., 5 years 6 months = 5.5)
            _totalExperienceDecimal = _totalExpYears + (_totalExpMonths / 12m);
            
            var success = await EmployeeService.UpdateTotalExperienceAsync(
                _currentEmployee.EmployeeId, 
                _totalExperienceDecimal);
            
            if (success)
            {
                _currentEmployee.YearsOfExperience = _totalExperienceDecimal;
                Snackbar.Add($"Total experience updated to {_totalExperienceDecimal} years!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update experience", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating experience: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddSkill()
    {
        if (_currentEmployee == null)
        {
            Snackbar.Add("Not authenticated", Severity.Error);
            return;
        }

        // Validation
        if (_newSkillId == null)
        {
            Snackbar.Add("Please select a skill", Severity.Warning);
            return;
        }

        // ⭐ CHECK FOR DUPLICATE
        var existingSkill = _mySkills.FirstOrDefault(s => s.SkillId == _newSkillId.Value);
        if (existingSkill != null)
        {
            Snackbar.Add($"'{existingSkill.Skill.SkillName}' is already added. Please update it instead.", Severity.Warning);
            return;
        }

        // ⭐ VALIDATE SKILL EXPERIENCE DOES NOT EXCEED TOTAL EXPERIENCE
        if (_totalExperienceDecimal == 0)
        {
            Snackbar.Add("Please update your total experience first", Severity.Warning);
            return;
        }

        if (_newSkillYears > _totalExperienceDecimal)
        {
            Snackbar.Add($"Skill experience ({_newSkillYears} years) cannot exceed total experience ({_totalExperienceDecimal} years)", 
                         Severity.Warning);
            return;
        }

        try
        {
            var newSkill = new EmployeeSkill
            {
                EmployeeId = _currentEmployee.EmployeeId,
                SkillId = _newSkillId.Value,
                YearsOfExperience = _newSkillYears,
                ProficiencyLevel = _newSkillLevel,
                LastUsedDate = _newSkillLastUsed,
                Source = "Manual"
            };

            await EmployeeService.AddSkillAsync(newSkill);
            _mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee.EmployeeId);
            
            // Reset form
            _newSkillId = null;
            _newSkillYears = 1;
            _newSkillLevel = "Intermediate";
            _newSkillLastUsed = DateTime.Now;
            
            Snackbar.Add("Skill added successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding skill: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateAvailability()
    {
        if (_currentEmployee == null) return;

        try
        {
            var success = await EmployeeService.UpdateAvailabilityAsync(
                _currentEmployee.EmployeeId, 
                _availabilityStatus);
            
            if (success)
            {
                _currentEmployee.AvailabilityStatus = _availabilityStatus;
                Snackbar.Add("Availability updated!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update availability", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating availability: {ex.Message}", Severity.Error);
        }
    }

    private void EditSkill(EmployeeSkill skill)
    {
        _editingSkill = skill;
        _newSkillYears = skill.YearsOfExperience;
        _newSkillLevel = skill.ProficiencyLevel ?? "Intermediate";
        _newSkillLastUsed = skill.LastUsedDate;
    }

    private async Task SaveEditedSkillInline()
    {
        if (_editingSkill == null) return;

        // ⭐ VALIDATE SKILL EXPERIENCE
        if (_newSkillYears > _totalExperienceDecimal)
        {
            Snackbar.Add($"Skill experience ({_newSkillYears} years) cannot exceed total experience ({_totalExperienceDecimal} years)", 
                         Severity.Warning);
            return;
        }

        try
        {
            _editingSkill.YearsOfExperience = _newSkillYears;
            _editingSkill.ProficiencyLevel = _newSkillLevel;
            _editingSkill.LastUsedDate = _newSkillLastUsed;

            await EmployeeService.UpdateSkillAsync(_editingSkill);
            _mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee!.EmployeeId);
            
            _editingSkill = null;
            ResetSkillForm();
            
            Snackbar.Add("Skill updated successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating skill: {ex.Message}", Severity.Error);
        }
    }

    private void CancelEdit()
    {
        _editingSkill = null;
        ResetSkillForm();
    }

    private void ResetSkillForm()
    {
        _newSkillId = null;
        _newSkillYears = 1;
        _newSkillLevel = "Intermediate";
        _newSkillLastUsed = DateTime.Now;
    }

    private string FormatTotalExperience()
    {
        if (_totalExperienceDecimal <= 0) return "0 years";
        
        int years = (int)_totalExperienceDecimal;
        int months = (int)((_totalExperienceDecimal - years) * 12);
        
        if (months == 0)
            return $"{years} year{(years > 1 ? "s" : "")}";
        
        return $"{years} year{(years > 1 ? "s" : "")} and {months} month{(months > 1 ? "s" : "")}";
    }

    private async Task DeleteSkill(EmployeeSkill skill)
    {
        if (_currentEmployee == null) return;

        bool? confirm = await _dialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to remove '{skill.Skill.SkillName}' from your profile?",
            yesText: "Delete", 
            cancelText: "Cancel");

        if (confirm != true) return;

        try
        {
            var success = await EmployeeService.DeleteSkillAsync(skill.EmployeeSkillId);
            
            if (success)
            {
                _mySkills = await EmployeeService.GetEmployeeSkillsAsync(_currentEmployee.EmployeeId);
                Snackbar.Add($"'{skill.Skill.SkillName}' removed", Severity.Info);
            }
            else
            {
                Snackbar.Add("Skill not found", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Delete error: {ex}");
            Snackbar.Add($"Error removing skill: {ex.Message}", Severity.Error);
        }
    }

    private Color GetLevelColor(string? level)
    {
        return level switch
        {
            "Expert" => Color.Success,
            "Advanced" => Color.Primary,
            "Intermediate" => Color.Warning,
            "Beginner" => Color.Info,
            _ => Color.Default
        };
    }

    public class ExtractedSkill
    {
        public string SkillName { get; set; } = "";
        public decimal? YearsOfExperience { get; set; }
        public string? ProficiencyLevel { get; set; }
        public decimal ConfidenceScore { get; set; }
    }
}